name: Openfire CI

env:
  CI: true
  OPENFIRE_VERSION: "4.9.0"

on: [push, pull_request]


jobs:
  run-action:

    name: Execute Github Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local action
        uses: actions/checkout@v4
        with:
          path: self # different from the checkout done in the next step (which is otherwise overwritten).
      
      - name: Run Openfire
        uses: igniterealtime/launch-openfire-action@v1.1.2
        with:
          version: ${{env.OPENFIRE_VERSION}}
      
      - name: Run the action that's developed in this repository
        uses: ./self/
        with:
          domain: 'example.org'
          adminAccountUsername: 'admin'
          adminAccountPassword: 'admin'
          disabledTests: 'EntityCapsTest,SoftwareInfoIntegrationTest,XmppConnectionIntegrationTest,StreamManagementTest,WaitForClosingStreamElementTest,IoTControlIntegrationTest,ModularXmppClientToServerConnectionLowLevelIntegrationTest,MultiUserChatOccupantIntegrationTest,MultiUserChatRolesAffiliationsPrivilegesIntegrationTest,ServiceDiscoveryIntegrationTest,VCardTempIntegrationTest'
          disabledSpecifications: 'RFC6121,XEP-0045,XEP-0066'
          logDir: ./output
      - name: Stop CI server
        if: ${{ always() && steps.startCIServer.conclusion == 'success' }} # TODO figure out if this is correct. The intent is to have the server stopped if it was successfully started, even if the tests fail. Failing tests should still cause the job to fail.
        uses: ./tools/.github/actions/stopserver-action
