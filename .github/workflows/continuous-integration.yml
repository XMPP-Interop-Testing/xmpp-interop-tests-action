name: Openfire CI

env:
  CI: true
  OPENFIRE_VERSION: "5.0.1"

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]


jobs:
  run-action-admin:

    name: Execute (using XEP-0133 Service Administration)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local action
        uses: actions/checkout@v4

      - name: Run Openfire
        uses: igniterealtime/launch-openfire-action@v1.2.0
        with:
          version: ${{env.OPENFIRE_VERSION}}

      - name: Run the action that's developed in this repository
        uses: ./
        with:
          testId: 'provisioning-admin'
          domain: 'example.org'
          adminAccountUsername: 'admin'
          adminAccountPassword: 'admin'
          enabledSpecifications: 'XEP-0115,XEP-0199,XEP-0352'

  run-action-accounts:

    name: Execute (using explicit test accounts)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local action
        uses: actions/checkout@v4

      - name: Run Openfire
        uses: igniterealtime/launch-openfire-action@v1.2.0
        with:
          version: ${{env.OPENFIRE_VERSION}}

      - name: Run the action that's developed in this repository
        uses: ./
        with:
          testId: 'provisioning-static-accounts'
          domain: 'example.org'
          accountOneUsername: 'jane'
          accountOnePassword: 'secret'
          accountTwoUsername: 'juan'
          accountTwoPassword: 'secret'
          accountThreeUsername: 'john'
          accountThreePassword: 'secret'
          enabledSpecifications: 'XEP-0115,XEP-0199,XEP-0352'

  run-action-ibr:

    name: Execute (using XEP-0077 In-Band Registration)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local action
        uses: actions/checkout@v4

      - name: Run Openfire
        uses: igniterealtime/launch-openfire-action@v1.2.0
        with:
          version: ${{env.OPENFIRE_VERSION}}

      - name: Run the action that's developed in this repository
        uses: ./
        with:
          testId: 'provisioning-ibr'
          domain: 'example.org'
          enabledSpecifications: 'XEP-0115,XEP-0199,XEP-0352'

  run-action-fail-on-impossible-test:

    name: Test the 'fail-on-impossible-test' configuration option
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local action
        uses: actions/checkout@v4

      - name: Run Openfire
        uses: igniterealtime/launch-openfire-action@v1.2.0
        with:
          version: ${{env.OPENFIRE_VERSION}}

      - name: Run the action that's developed in this repository
        id: testExecution
        continue-on-error: true
        uses: ./
        with:
          testId: 'fail-on-impossible-test'
          domain: 'example.org'
          adminAccountUsername: 'admin'
          adminAccountPassword: 'admin'
          enabledSpecifications: 'XEP-0215,XEP-0199'
          failOnImpossibleTest: 'true'

      - name: Assert that the action failed as expected
        # Using continue-on-error: true results in `conclusion` being a success, while `outcome` can differ. `if: failure()` looks at `conclusion`
        if: ${{ steps.testExecution.outcome != 'failure' }}
        run: |
          echo "‚ùå Action execution succeeded, but failure was expected!"
          exit 1
        shell: bash

  run-action-extension-jar:

    name: Test the 'extensionJar' configuration option
    runs-on: ubuntu-latest

    steps:
      - name: Checkout local action
        uses: actions/checkout@v4

      - name: Run Openfire
        uses: igniterealtime/launch-openfire-action@v1.2.0
        with:
          version: ${{env.OPENFIRE_VERSION}}
 
      - name: Run the action that's developed in this repository
        uses: ./
        with:
          testId: 'extended-classpath'
          domain: 'example.org'
          extensionJar: '.github/workflow-resources/extended.jar'
          enabledTests: 'ExtendedClasspathTest'
